---
title: "Seminar 2"
author: "Uyen"
date: "8/28/2020"
output: html_document
---

```{r setup, echo = FALSE, include=TRUE}
knitr::opts_chunk$set(echo = TRUE,message=FALSE, warning=FALSE)
```

``` {r libraries}
library(dplyr)
library(tidyverse)
library(here)
library(DataCombine)
library(lme4)
```

```{r loaddata, include=TRUE, cache=TRUE}
dict_path <- here("capstone20_dictionaries.csv")  
wordcount_path <- here("dictionary_word_matrix_adj.csv") 
coun_lang1_path <- here("CIA fact sheet-2.csv")
disease_path <- here("Disease_Incidences.csv")
population_path <- here("World_population.csv")
geographical_path <- here("Cultural-Clusters.csv")
```

```{r PANAS-dataset, include=TRUE, warning= FALSE}
#create PANAS dataset
dict <- read_csv(dict_path, col_types = cols(id = col_character()) ) 

adjcount <- read_csv(wordcount_path,  col_types = cols(id = col_character(), 
                                                       year= col_integer(), 
                                                       title = col_character(), 
                                                       langname = col_character(), 
                                                       gcode = col_character(), 
                                                       area = col_character(), 
                                                       langfamily = col_character(), 
                                                       affiliation = col_character(), 
                                                       .default=col_double()))  %>% 
  mutate(dictsize = select(., abbreviated:zealous) %>% apply(1, sum, na.rm=TRUE)) 

positive_words <- c("active","alert","attentive","enthusiastic","excited","interested","proud","happy", "joyful","delighted","cheerful","lively","energetic","strong","confident","bold","daring","fearless")
negative_words <- c("afraid","scared","nervous","jittery","irritable","hostile","guilty","ashamed","upset", "distressed","frightened","shaky","angry","disgusted","sad","lonely")


word_count <- adjcount %>% 
  select(id, all_of(positive_words), all_of(negative_words), dictsize) %>% mutate_all(~replace_na(.x, 0))

unit <- 10000

word_frequencies <- dict %>% 
 inner_join(word_count, by="id") %>%
  filter(dictsize >= 5000)

for (word in c(positive_words, negative_words))
{word_frequencies <- word_frequencies %>% mutate(!!sym(word) :=  unit * !!sym(word)/dictsize)}

word_frequencies$mean_positive<-rowSums(word_frequencies[,positive_words])
word_frequencies$mean_negative<-rowSums(word_frequencies[,negative_words])

panas_frequencies <- aggregate(word_frequencies, by = list(language = word_frequencies$langname),FUN = mean)

panas_frequencies <- panas_frequencies %>% select(language, mean_positive, mean_negative)

```

Change language names to match CIA and dictionary dataset
```{r CIA-dataset, include=TRUE,  warning= FALSE}

coun_lang1 <- read_csv(coun_lang1_path)

replaces <- data.frame(from = c("Albanian", "Bosnian", "Khmer", "Croatian", "Serbian", "Arabic", "Mandarin", "Persian", "Mongolian", "Greek", "Hebrew", "Armenian", "Malay", "Kyrgyz"), 
                       to = c("Northern Tosk Albanian", "Serbian-Croatian-Bosnian", "Central Khmer", "Serbian-Croatian-Bosnian", "Serbian-Croatian-Bosnian", "Standard Arabic", "Mandarin Chinese", "Western Farsi", "Halh Mongolian", "Modern Greek", "Modern Hebrew", "Eastern Armenian", "Standard Malay", "Kirghiz"))

coun_lang <- FindReplace(data = as.data.frame(coun_lang1), 
                         Var = "Language", 
                         replaceData = replaces, 
                         from = "from", to = "to", exact = TRUE)
```

Joining Cultural clusters, CIA, MH prevalence and PANAS

```{r Merge-all,  include =TRUE, warning= FALSE}
mh <- read_csv(disease_path)
population <- read.csv(population_path)
geographical_region <- read_csv(geographical_path) 

#merge cultural cluster & CIA factsheet
cul_lang <- merge(x = geographical_region, y = coun_lang, 
               by.x = "Country", by.y = "Country")
#missing countries
print(geographical_region$Country[!(geographical_region$Country %in% coun_lang$Country)])

#merge incidence rates & total population
incidence <- mh %>%   select(location, val, cause) %>% 
  filter(!cause == "Dysthymia")%>%
  rename(incidence_count = val)

world_pop <- population %>% 
  filter(age_group_id == "22" & year_id == "2017" & sex_id =="3") %>%
  rename(total_pop = val)%>%
  select(location_name, total_pop)

disease_pop <- merge( x= incidence, y=world_pop, 
                      by.x = "location", 
                      by.y = "location_name")

Cul_lang_pop <- merge(x= cul_lang, y = disease_pop, 
                      by.x = "Country", 
                      by.y = "location")

d <- merge(x= Cul_lang_pop, y = panas_frequencies, 
           by.x = "Language", 
           by.y = "language")
```

```{r dataset}
d1 <- d %>% group_by(Country)%>% 
  mutate(mean_positive = weighted.mean(mean_positive, Percentage/100)) %>%
  mutate(mean_negative = weighted.mean(mean_negative, Percentage/100)) %>%
  mutate(Percentage = sum(Percentage)/2) %>% 
  distinct()

#Exclude country with <80% language accounted for
d2 <- d1 %>% 
  subset(Percentage >= 80) %>% 
  subset(select = -c(Percentage))%>% 
  mutate(total = mean_negative + mean_positive)

d_wide <- d2 %>% 
  pivot_wider(names_from = "cause", values_from="incidence_count")%>%
  rename(c("major_depressive_disorder"="Major depressive disorder",  "anxiety_disorders" = "Anxiety disorders","cluster" = "Cultural Cluster" ))

```

Control variable



## Exploratory Plots
```{r, include=TRUE}
plotd <- d_wide %>% 
  mutate(AD_incidence = anxiety_disorders/total_pop,
         MDD_incidence = major_depressive_disorder/total_pop) 

plotd %>% ggplot(mapping = aes(x= AD_incidence, y= total))+
  geom_point()+
  geom_smooth(method=lm)+
  labs(title= "Correlation of AD prevalence and proportion of emotion words",
       x="AD prevalence", y="counts per 1000")

plotd %>% ggplot(mapping = aes(x= MDD_incidence, y= total))+
  geom_point()+
  geom_smooth(method=lm)+
  labs(title= "Correlation of MDD prevalence and proportion of emotion words",
       x="MDD prevalence", y="counts per 1000")


```


##Statistical Analysis - Mixed Model Regression
```{r MD regression, include=TRUE}
# We will not used linear regression in our lab report because one of the assumption in linear regression is independence of data, and our country data violate this assumption. Instead, we will use mixed model regression. We found a study that group countries based on cultural clusters (Mensah, Y. M., & Chen, H. Y. (2013). Global clustering of countries by cultureâ€“an extension of the GLOBE study.) and we will use this cultural cluster as our random effect for the analysis. 


FullDepressionModel <- glmer(cbind(major_depressive_disorder, total_pop - major_depressive_disorder) ~ mean_positive + (1|cluster), data = d_wide, family = binomial, control=glmerControl(optimizer="bobyqa"))
beta_temp <- round(coef(summary(FullDepressionModel))[2,"Estimate"], 2)
show(FullDepressionModel)

ReducedDepressionModel <- glmer(cbind(major_depressive_disorder, total_pop - major_depressive_disorder) ~ (1|cluster), data = d_wide, family = binomial, control=glmerControl(optimizer="bobyqa"))

a1<-anova(FullDepressionModel,ReducedDepressionModel)
p_value <-  signif(a1$"Pr(>Chisq)"[2] , digits=3)
chi_sq <- signif(a1$Chisq[2], digits=3)
df <- a1$Df[2]
show(a1)

```

```{r AD regression}
FullADModel <- glmer(cbind(anxiety_disorders, total_pop - anxiety_disorders) ~ mean_positive + (1|cluster), data = d_wide, family = binomial, control=glmerControl(optimizer="bobyqa"))
beta_temp <- round(coef(summary(FullADModel))[2,"Estimate"], 2)
show(FullDepressionModel)

ReducedADModel <- glmer(cbind(anxiety_disorders, total_pop - anxiety_disorders) ~ (1|cluster), data = d_wide, family = binomial, control=glmerControl(optimizer="bobyqa"))

a1<-anova(FullADModel,ReducedADModel)
p_value <-  signif(a1$"Pr(>Chisq)"[2] , digits=3)
chi_sq <- signif(a1$Chisq[2], digits=3)
df <- a1$Df[2]
show(a1)
```

##Notes:
At the moment we decided our independent variable is mean frequency of positive words, and our dependent variables are prevalence of major depression, dysthymia and anxiety disorder. For the results, we will report the stat block with chi-square value, df, p-value, for all  3 mixed model regression analysis we ran. We followed the tutorial on pdf and use lmer function instead of glmer, as we understand that we do not have a variable dictsize and langfamily as our random effect. Is our attempt at mixed model regression analysis correct? And is cultural cluster a valid random effect for our regression models? 
